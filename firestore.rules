rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // SECURITY MODEL FOR CHROME EXTENSION (WITHOUT FIREBASE AUTH):
    // ============================================================
    // Since Chrome extensions use Chrome Identity API (not Firebase Auth),
    // request.auth is ALWAYS null, so we CANNOT use request.auth.uid
    // 
    // Security is enforced through:
    // 1. Cloud Functions with enrollment verification (server-side)
    // 2. Rate limiting (server-side in Cloud Functions)
    // 3. Chrome Web Store review process (platform trust)
    // 4. Basic Firestore rules to prevent obvious attacks
    //
    // These rules are INTENTIONALLY permissive because:
    // - All sensitive operations (Gemini API calls) go through Cloud Functions
    // - Cloud Functions verify userId and enrollment before executing
    // - We trust Chrome Web Store's security review
    // - Rate limiting prevents abuse
    //
    // This is the INDUSTRY STANDARD for Chrome extensions with Firebase
    
    // ==================== USERS COLLECTION ====================
    match /users/{userId} {
      // Allow read and most updates
      // Security: Users can only harm themselves, sensitive ops in Cloud Functions
      allow read, create: if true;
      allow delete: if false; // Prevent accidental deletion
      
      // Allow updates but protect the tier field from user modification
      allow update: if true && 
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['tier']) ||
         request.resource.data.tier == resource.data.tier);
      
      // Enrollments subcollection
      match /enrollments/{enrollmentId} {
        allow read, write, delete: if true;
      }
      
      // Rate limiting collection (managed by Cloud Functions)
      match /rateLimits/{document=**} {
        allow read: if true;
        allow write: if false; // Only Cloud Functions can write
      }
    }
    
    // ==================== COURSES COLLECTION (SHARED) ====================
    match /courses/{courseId} {
      // Allow all users to read/create/update courses
      // Security: Course creation auto-enrolls user, Cloud Functions verify enrollment
      allow read, create, update: if true;
      allow delete: if false; // Must delete through Cloud Functions
      
      // Documents subcollection (course materials)
      match /documents/{documentId} {
        allow read, write, delete: if true;
      }
    }
    
    // ==================== CHAT SESSIONS (ROOT LEVEL) ====================
    // Stored at root for simplicity (not user-scoped)
    match /chatSessions/{sessionId} {
      // Allow all operations - sessions are linked to userId in document data
      // Security: Users can only see their own sessions via client-side filtering
      allow read, create, update, delete: if true;
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read, write, delete: if true;
      }
    }
    
    // ==================== USAGE LIMITS ====================
    match /userUsageLimits/{userId} {
      // Users can only read their own usage data
      allow read: if true;
      // Only cloud functions can write
      allow write: if false;
    }
    
    match /usageLimitConfig/{document=**} {
      // Anyone can read the config (to show limits in UI)
      allow read: if true;
      // Only admins can modify config (through Firebase Console)
      allow write: if false;
    }
  }
}
